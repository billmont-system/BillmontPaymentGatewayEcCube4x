![LOGO](https://payment-hub.billmont.net/img/color-logo.png)

# BillmontPaymentGateway

EC-CUBE4.x用のBillmontクレジット決済プラグインです。  
EC-CUBE3.xをご利用の場合は、コチラのプラグインには対応しておりません。

# はじめに

- 本決済モジュールはサイトとショップIDが１対１の場合を前提にご用意しております。
同じサイトで複数のショップIDを設定する場合は想定しておりません。
- 作業を行われる場合は、必ずEC-CUBEすべてのバックアップの取得をお願いします。
- 返金機能はついていません。返金については弊社管理システムより行ってください。
- カスタマイズに関するお問い合わせには対応しておりません。
- EC-CUBE(本体)に関するお問い合わせにつきましては、下記「開発コミュニティ」をご利用ください。

http://xoops.ec-cube.net/  
https://github.com/EC-CUBE/


## 動作環境

あらかじめ、以下URLにてご利用の環境が要件を満たしている事をご確認下さい。

http://www.ec-cube.net/product/system.php

決済モジュールとEC-CUBE本体のバージョンは以下になっています。

| 決済モジュール | EC-CUBE本体 |
|:----|:----|
| `1.0.0` | `4.0.3` `4.0.4` `4.0.5` |

# 決済モジュールの設定について

## 1.決済モジュール導入完了までの流れ

EC-CUBE決済モジュールの導入は下記５つの手順にて行います。

![step](https://user-images.githubusercontent.com/73977441/119608024-3f060980-be30-11eb-8334-dd13f5903472.png)

## 2.決済モジュールをインストール

### ダウンロード

下記URLよりプラグインファイルをダウンロードしてください。

https://github.com/billmont-system/BillmontPaymentGatewayEcCube4x/releases/tag/1.0.0

### インストール

- EC-CUBE管理画面にログインし、メニュー `オーナーズストア` > `プラグイン` > `プラグイン一覧`をクリックし`プラグイン一覧`のページへ遷移してください。
- 独自プラグインの`プラグインのアップロードはこちら`をクリックしてください。  
- プラグインのアップロードへ移動したら`ファイルを選択`ボタンをクリックし、上記ダウンロードよりダウンロードした`BillmontPaymentGateway_eccube4x_vx.x.x.zip`ファイルを選択してください。  
ファイル選択ができましたら`アップロード`ボタンをクリックしてください。  

プラグインページへ戻り、一覧に`BillmontPaymentGateway `が表示されていましたらインストールが成功です。

### 決済モジュールの有効化

アップロードした段階では、決済モジュールは<b style="color:red">停止中</b>です。  
一覧にある`▶`をクリックしてください。  
`▶`が消え、設定ボタンが表示されましたら、決済モジュールは有効になりました。  
次は決済モジュールの設定を行います。


## 3.決済モジュールの設定を行う

- 設定`歯車`ボタンをクリックしてください。
- 設定画面に移動したら、契約した際に弊社が発行した`API TOKEN`を入力してください。
APIドメインには`payment-hub.billmont.net`を入力してください。  
入力が完了したら`設定`ボタンをクリックしてください。  

<b style="color:red;">API TOKEN/SECURETは店舗管理システムにログイン後、`利用内容` => `システム利用内容`のページからご確認いただけます。</b>

### (2) 決済通知URLの設定

EC-CUBEが決済通知を受取るために、弊社管理システム側で決済通知URLの設定が必要です。

https://merchant-portal.billmont.net/

ログイン後、メニュー `決済システム管理` > `リダイレクト決済` > `結果通知設定(HTTP)` をクリックし、結果通知設定(HTTP)画面に遷移してください。  
**ログインは店舗様向けログイン情報にてログインしてください**

下記内容を設定してください。
- **送信状態**  
送信する(GET)
- **HTTP結果通知**

```
http(s)://<あなたのEC-CUBEサイトドメイン>/billmont_payment/receive_complete
```

入力が完了したら`保存`ボタンをクリックしてください。

## 4.支払い方法設定を行う

EC-CUBE管理画面のメニュー `設定` > `店舗設定` > `支払方法設定`をクリックし、支払方法管理ページへ遷移してください。

- `Billmontクレジットカード決済`が追加されています。
- 一覧の`支払い名`をクリックすると`編集`ページに移動します。
- 支払い方法について、名称や手数料はご自由に設定してください。  
利用条件は弊社と契約した際に発行された、決済可能金額を設定してください。  
弊社の管理システムからご確認いただけます。

## 5. 配送方法設定を行う
EC-CUBE管理画面のメニュー `設定` > `店舗設定` > `配送方法設定`をクリックし、配送方法管理ページへ遷移してください。

- 対象の配送方法の`タイトル`をクリックすると`編集`ページへ移動します。
- 支払い方法設定で`Billmontクレジットカード決済`にチェックをいれて、`登録`してください。

## 6. 動作確認を行う

実際にEC-CUBEにて商品をカートに入れてレジにすすみます。  
支払い方法を`Billmontクレジットカード決済`に変更し、`Billmontクレジットカード決済へ`ボタンをクリックしてください。

弊社の決済ページへ遷移すれば正常に動作しております。

# 7. 受注内容確認＆対応状況の更新

## 7.1. 受注内容確認
EC-CUBE管理画面にログインし、メニュー `受注管理` > `受注マスター`をクリックし`受注マスター`のページへ遷移してください。  
対象の受注編集ページを開きます。
赤枠の様に`決済状況` `決済承認番号` `決済明細表記名`が表示されます。

## 7.2. 受注内容確認

店舗様向け管理画面にログインしてください。
https://merchant-portal.billmont.net/

- ログイン後 `決済一覧` をクリックしてください。
- 検索画面の`承認番号`に　EC-CUBEに記載されている`決済承認番号`にて検索をしてください。

## 7.3. 対応状況更新

EC-CUBEの受注編集ページにて`対応状況`を**入金済み**に更新してください。


# そのた

### 決済が完了したタイミングで入金済みしたい場合。

EC-CUBEのデフォルトのステータス遷移設定では、**入金済み**にすることはできません。
受注ステータスを入金済みにする場合「app/config/eccube/packages/order_state_machine.php」を変更してください。

参考URL: https://doc4.ec-cube.net/customize_order_state_machine

